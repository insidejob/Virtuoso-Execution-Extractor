# ðŸŽ¯ Variable Optimization Design

## Current Issues
1. Variables marked as "LOCAL" when they're actually from environment/test data
2. No indication of expected data type (string, number, email, etc.)
3. Missing context about what the variable represents
4. No validation rules or format requirements

## Proposed Enhanced Variable Structure

### Variable Categories

#### 1. **TEST_DATA** (Data Attributes)
Variables from Virtuoso's data attributes - used for data-driven testing
```json
{
  "$QuestionType1": {
    "category": "TEST_DATA",
    "source": "dataAttributeValues",
    "dataType": "string",
    "currentValue": "Precautions",
    "description": "Permit check question category",
    "usage": "Assertion text for permit verification"
  }
}
```

#### 2. **ENVIRONMENT** 
Variables from environment configuration - different per environment
```json
{
  "$username": {
    "category": "ENVIRONMENT",
    "source": "environment.variables",
    "dataType": "string",
    "format": "email",
    "currentValue": "admin",
    "description": "Login credential - username",
    "validation": "Must be valid email format",
    "example": "user@example.com"
  }
}
```

#### 3. **LOCAL**
Variables created within the journey via STORE actions
```json
{
  "$age": {
    "category": "LOCAL",
    "source": "STORE action",
    "dataType": "number",
    "format": "integer",
    "storedValue": "25",
    "description": "Age value for comparison tests",
    "validation": "Numeric, used in LESS_THAN comparisons"
  }
}
```

#### 4. **SYSTEM**
Variables generated by Virtuoso system
```json
{
  "$timestamp": {
    "category": "SYSTEM",
    "source": "Virtuoso runtime",
    "dataType": "string",
    "format": "ISO 8601 datetime",
    "description": "Test execution timestamp",
    "example": "2025-08-11T16:47:16.197Z"
  }
}
```

## Data Type Inference Rules

### From Field Names/Hints
| Field Contains | Inferred Type | Format |
|----------------|---------------|---------|
| email, username | string | email |
| password, pwd | string | password |
| age, count, number | number | integer |
| price, amount, cost | number | decimal |
| date, time | string | datetime |
| url, link | string | url |
| phone, mobile | string | phone |

### From Actions
| Action | Context | Inferred Type |
|--------|---------|---------------|
| ASSERT_VARIABLE | LESS_THAN, GREATER_THAN | number |
| ASSERT_VARIABLE | EQUALS with quotes | string |
| ASSERT_VARIABLE | Expression evaluation | computed |
| WRITE | In email field | email string |
| WRITE | In password field | password string |

### From Variable Names
| Pattern | Inferred Type | Example |
|---------|---------------|---------|
| `$*Count`, `$*Number` | number | $itemCount â†’ number |
| `$*Name`, `$*Text` | string | $userName â†’ string |
| `$*Flag`, `$is*` | boolean | $isEnabled â†’ boolean |
| `$*Date`, `$*Time` | datetime | $startDate â†’ datetime |
| `$*Url`, `$*Link` | url | $apiUrl â†’ url string |

## Enhanced Output Format

```json
{
  "summary": {
    "total": 12,
    "byCategory": {
      "TEST_DATA": 10,
      "ENVIRONMENT": 2,
      "LOCAL": 0,
      "SYSTEM": 0
    },
    "byDataType": {
      "string": 10,
      "number": 0,
      "boolean": 0,
      "password": 2
    }
  },
  "variables": {
    "$username": {
      "category": "ENVIRONMENT",
      "source": {
        "type": "environment",
        "location": "Default Environment"
      },
      "dataType": {
        "primary": "string",
        "format": "email",
        "pattern": "^[^@]+@[^@]+\\.[^@]+$"
      },
      "currentValue": "admin",
      "usage": {
        "count": 1,
        "locations": [
          {
            "checkpoint": "Login",
            "step": 1,
            "action": "WRITE",
            "field": "Enter your email",
            "purpose": "Authentication"
          }
        ]
      },
      "validation": {
        "required": true,
        "format": "Valid email address",
        "example": "user@example.com",
        "constraints": ["Must be registered user", "Case-insensitive"]
      }
    },
    "$password": {
      "category": "ENVIRONMENT",
      "source": {
        "type": "environment",
        "location": "Default Environment",
        "secure": true
      },
      "dataType": {
        "primary": "string",
        "format": "password",
        "sensitive": true
      },
      "currentValue": "********",
      "usage": {
        "count": 1,
        "locations": [
          {
            "checkpoint": "Login",
            "step": 3,
            "action": "WRITE",
            "field": "Password",
            "purpose": "Authentication"
          }
        ]
      },
      "validation": {
        "required": true,
        "format": "Secure password",
        "constraints": ["Minimum 8 characters", "Hidden in logs"]
      }
    },
    "$QuestionType1": {
      "category": "TEST_DATA",
      "source": {
        "type": "dataAttribute",
        "location": "Journey data attributes",
        "key": "QuestionType1"
      },
      "dataType": {
        "primary": "string",
        "format": "text",
        "domain": ["Precautions", "General Work", "PPE", "Isolation"]
      },
      "currentValue": "Precautions",
      "usage": {
        "count": 1,
        "locations": [
          {
            "checkpoint": "Check a Permit",
            "step": 3,
            "action": "ASSERT_EXISTS",
            "purpose": "Verify permit question displayed"
          }
        ]
      },
      "validation": {
        "required": true,
        "format": "Permit question category",
        "allowedValues": ["Precautions", "General Work", "PPE", "etc..."]
      }
    }
  },
  "recommendations": {
    "missing": [
      {
        "variable": "$signaturebox",
        "suggestion": "Define as element selector in test data",
        "category": "TEST_DATA",
        "dataType": "selector"
      }
    ],
    "improvements": [
      {
        "variable": "$username",
        "issue": "Using literal 'admin' - should use environment variable",
        "solution": "Move to environment configuration for better test portability"
      }
    ]
  }
}
```

## Implementation Plan

### Phase 1: Variable Categorization
1. Check if variable exists in `dataAttributeValues` â†’ TEST_DATA
2. Check if variable value comes from environment â†’ ENVIRONMENT
3. Check if variable created via STORE action â†’ LOCAL
4. Check if variable is system-generated â†’ SYSTEM

### Phase 2: Data Type Inference
1. Analyze field names where variable is used
2. Check action types (ASSERT comparisons)
3. Pattern match variable names
4. Examine current values

### Phase 3: Context Enhancement
1. Track all usage locations
2. Identify purpose from action context
3. Extract validation rules from assertions
4. Generate helpful descriptions

### Phase 4: Validation & Recommendations
1. Flag missing variable definitions
2. Suggest better categorization
3. Identify security concerns (passwords in plain text)
4. Recommend data type improvements

## Benefits

1. **Clear Understanding**: Developers know exactly what data each variable needs
2. **Better Test Data Management**: Separate test data from environment config
3. **Type Safety**: Know if a variable should be numeric for comparisons
4. **Security**: Identify sensitive data that needs protection
5. **Portability**: Easy to run tests in different environments
6. **Documentation**: Self-documenting variable usage

## Example Use Cases

### Check a Permit Journey
- **TEST_DATA**: All QuestionType variables (domain-specific values)
- **ENVIRONMENT**: username, password (credentials vary by environment)
- **LOCAL**: None in this journey

### API Test Journey
- **LOCAL**: $age, $var1, $var2 (created via STORE)
- **ENVIRONMENT**: $url (API endpoint)
- **TEST_DATA**: Expected response values